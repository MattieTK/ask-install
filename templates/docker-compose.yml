# DO NOT EDIT FILE, AUTOGENERATED.
#
# Reuse the ask-install after editing the config file and re-run the ask-install
# tool with `-s`:
#
#  ask-install -s
#

version: '2'

##########################
# Services
##########################

services:

  cay:
    image: coralproject/cay:{{ .Channel }}
    restart: on-failure:10
    environment:
      - "GAID={{ .GoogleAnalyticsID }}"
      - "AUTH_CLIENT_ID=cay"
      - "AUTH_AUTHORITY={{ .RootURL }}/auth/connect"
      - "ELKHORN_URL={{ .RootURL }}/elkhorn"
      - "ASK_URL={{ .RootURL }}/askd"
      - "AUTH_ENABLED=true"
      - "TRUST=false"
    networks:
      - back-shelf

  {{ if .SlackNotificationsEnabled -}}
  slack:
    image: coralproject/slack-bouncer:latest
    restart: on-failure:10
    environment:
      - "PORT=80"
      - "SLACK_URL={{ .SlackHook }}"
      - "SLACK_CHANNEL={{ .SlackChannel }}"
      - "SLACK_USERNAME=askbot"
      - "SLACK_ICON_EMOJI=:question:"
      - "TARGET_URL=http://askd/"
      - "MAPPINGS="
    networks:
      - back-shelf
    depends_on:
      - askd
  {{- end }}

  askd:
    image: coralproject/askd:{{ .Channel }}
    restart: on-failure:10
    environment:
      - "ASK_HOST=0.0.0.0:80"
      - "ASK_LOGGING_LEVEL=1"
      - "ASK_MONGO_URI=mongodb://shelf-mongo/test"
      - "ASK_ENABLE_CORS=TRUE"
      - "ASK_AUTH_PUBLIC_KEY={{ .AuthPublicKey }}"
      - "ASK_RECAPTCHA_SECRET={{ .RecaptchaSecret }}"
    networks:
      - back-shelf
    depends_on:
      - shelf-mongo

  elkhorn:
    image: coralproject/elkhorn:{{ .Channel }}
    restart: on-failure:10
    environment:
      - "ASK_URL=http://askd"
      - "S3_BUCKET={{ .S3Bucket }}"
      - "S3_BASE_URL={{ .S3Endpoint }}"
      - "AWS_REGION={{ .AWSRegion }}"
      - "AWS_ACCESS_KEY_ID={{ .AWSAccessKeyID }}"
      - "AWS_ACCESS_KEY={{ .AWSAccessKey }}"
      - "RECAPTCHA={{ .RecaptchaSecret }}"
      - "PUBLISHED_BASE_URL={{ if not .UseS3 }}{{ .RootURL }}/widgets/{{ end }}"
    {{ if not .UseS3 }}
    volumes:
      - ./elkhorn:/usr/src/app/server/widgets
    {{ end }}
    networks:
      - back-shelf
    depends_on:
      - askd

  auth:
    image: coralproject/coral-auth:{{ .Channel }}
    restart: on-failure:10
    environment:
      - "CORAL_AUTH_PORT=80"
      - "CORAL_AUTH_TRUST_PROXY=TRUE"
      - "CORAL_AUTH_TOKEN_EXPIRY_TIME=36 hr"
      - "CORAL_AUTH_MONGO_URL=mongodb://auth-mongo/test"
      - "CORAL_AUTH_PRIVATE_KEY={{ .AuthPrivateKey }}"
      - "CORAL_AUTH_PUBLIC_KEY={{ .AuthPublicKey }}"
      - "CORAL_AUTH_SESSION_SECRET={{ .SessionSecret }}"
      - "CORAL_AUTH_ALLOWED_CLIENTS=cay {{ .RootURL }}/callback"
      - "CORAL_AUTH_ROOT_URL={{ .RootURL }}/auth"
      - "CORAL_AUTH_DISABLE_FRAMEGUARD={{ if .UseWordpress }}TRUE{{ else }}FALSE{{ end }}"
    networks:
      - back-auth
    depends_on:
      - auth-mongo

  ##########################
  # Databases
  ##########################

  shelf-mongo:
    image: mongo:3.2
    restart: on-failure:10
    volumes:
      - shelf-mongo:/data/db
    networks:
      - back-shelf

  auth-mongo:
    image: mongo:3.2
    restart: on-failure:10
    volumes:
      - auth-mongo:/data/db
    networks:
      - back-auth

  ##########################
  # Web Servers
  ##########################

  caddy:
    image: abiosoft/caddy:0.9.5
    volumes:
      - ./Caddyfile:/etc/Caddyfile
      {{- if not .UseS3 }}
      - ./elkhorn:/var/www/widgets
      {{ end }}
      - caddy-certs:/root/.caddy
    ports:
      - "0.0.0.0:{{ .Port }}:{{ .Port }}"
      {{- if .UseSSL }}
      - "0.0.0.0:443:443"
      {{ end }}
    networks:
      - bastion
      - back-auth
      - back-shelf
    depends_on:
      - auth
      - askd
      - elkhorn
      - cay
      {{ if .SlackNotificationsEnabled -}}
      - slack
      {{- end }}

##########################
# Service Networks
##########################

networks:
  bastion:
  back-shelf:
  back-auth:

##########################
# Service Volumes
##########################

volumes:
  caddy-certs:
    external: false
  auth-mongo:
    external: false
  shelf-mongo:
    external: false
